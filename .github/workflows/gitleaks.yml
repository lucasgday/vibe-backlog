name: gitleaks

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build

      - name: Install gitleaks
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.24.2"
          TARBALL="gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          RELEASE_URL="https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}"
          curl -fsSL "${RELEASE_URL}/${TARBALL}" -o "/tmp/${TARBALL}"
          curl -fsSL "${RELEASE_URL}/gitleaks_${GITLEAKS_VERSION}_checksums.txt" -o /tmp/gitleaks_checksums.txt
          grep -F " ${TARBALL}" /tmp/gitleaks_checksums.txt > /tmp/gitleaks_checksum.txt
          (cd /tmp && sha256sum --check gitleaks_checksum.txt)
          tar -xzf "/tmp/${TARBALL}" -C /tmp gitleaks
          mkdir -p "$HOME/bin"
          install /tmp/gitleaks "$HOME/bin/gitleaks"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          "$HOME/bin/gitleaks" version

      - name: Run vibe security scan (fail policy)
        run: node dist/cli.cjs security scan --mode history --policy fail
